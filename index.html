<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Aulas</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        background-color: #f4f4f4; margin: 0; padding: 15px;
        display: flex; justify-content: center; align-items: flex-start;
        min-height: 100vh;
      }
      .container {
        width: 100%; max-width: 500px; background: #ffffff;
        padding: 25px; border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        box-sizing: border-box;
      }
      h2 { color: #4285f4; margin-top: 0; }
      div { margin-bottom: 20px; }
      label { display: block; font-weight: bold; margin-bottom: 8px; color: #5f6368; }
      input[type="text"], button {
        width: 100%; padding: 12px; font-size: 16px;
        border: 1px solid #ddd; border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #4285f4; color: white; font-weight: bold;
        border: none; cursor: pointer; transition: background-color 0.2s;
      }
      button:hover { background-color: #3367d6; }
      button:disabled { background-color: #9e9e9e; cursor: not-allowed; }
      #status {
        margin-top: 20px; font-weight: bold; font-size: 16px;
        word-wrap: break-word; /* Para que los errores largos no rompan el layout */
      }
      .success { color: green; }
      .error { color: red; }
      .loading { color: #5f6368; }

      /* --- Estilos para el botón de autorizar --- */
      .auth-section {
        background-color: #fef7e0;
        border: 1px solid #fce8b2;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
      }
      .auth-button {
        display: block;
        background-color: #f4b400;
        color: white;
        padding: 12px;
        font-size: 16px;
        font-weight: bold;
        text-decoration: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-align: center;
        box-sizing: border-box;
      }
      .auth-button:hover { background-color: #db9d00; }
      .small-text { font-size: 12px; color: #5f6368; margin-top: 10px; margin-bottom: 0; }
      hr { border: none; border-top: 1px solid #e0e0e0; margin: 25px 0; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Creador de Cursos de Classroom</h2>

      <div class="auth-section">
        <p style="margin-top:0; font-weight:bold;">Paso 1: Autorizar Permisos</p>
        <p>¿Primera vez aquí? Haz clic abajo para dar permisos a tu cuenta de Google.</p>
        
        <a href="https://script.google.com/macros/s/AKfycbwy0x19DeVxRQDoUGczRO4Zc6jFREMw-drJgRsTsRu6dDzsVqX1OgkPI4RTD7-E8pdtNA/exec" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="auth-button">
          Autorizar Permisos
        </a>
        
        <p class="small-text">Se abrirá una nueva pestaña. Ciérrala después de autorizar y vuelve aquí.</p>
      </div>

      <hr>

      <p style="font-weight:bold; margin-bottom: 20px;">Paso 2: Crea tu curso</p>

      <div>
        <label for="name">Nombre del Curso:</label>
        <input type="text" id="name" placeholder="Ej: Informática Aplicada a la Educación">
      </div>
      <div>
        <label for="section">Sección (Horario):</label>
        <input type="text" id="section" placeholder="Ej: Lunes 10:00 - 12:00">
      </div>
      <button id="createButton">Crear Curso</button>
      <div id="status"></div>
    </div>

  <script>
      // Tu URL está configurada correctamente
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwy0x19DeVxRQDoUGczRO4Zc6jFREMw-drJgRsTsRu6dDzsVqX1OgkPI4RTD7-E8pdtNA/exec";

      const button = document.getElementById('createButton');
      const statusDiv = document.getElementById('status');
      const nameInput = document.getElementById('name');
      const sectionInput = document.getElementById('section');

      button.addEventListener('click', handleCreateClick);

      async function handleCreateClick() {
        
        // --- HEMOS ELIMINADO EL BLOQUE 'if' PROBLEMÁTICO DE AQUÍ ---

        button.disabled = true;
        statusDiv.className = "loading";
        statusDiv.innerHTML = "Creando curso, por favor espera...";

        const courseData = {
          name: nameInput.value,
          section: sectionInput.value
        };

        try {
          const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'cors',
            credentials: 'include', // Correcto
            headers: {
              'Content-Type': 'text/plain;charset=utf-8',
            },
            redirect: 'manual', 
            body: JSON.stringify(courseData)
          });
          
          if (response.type === 'opaque' || response.type === 'opaqueredirect') {
             throw new Error("No estás autenticado. Por favor, usa el botón 'Autorizar Permisos' (Paso 1) y vuelve a intentarlo.");
          }

          const result = await response.json();

          if (result.status === 'success') {
            statusDiv.className = "success";
            statusDiv.innerHTML = result.message;
            nameInput.value = "";
            sectionInput.value = "";
          } else {
            throw new Error(result.message);
          }

        } catch (error) {
          statusDiv.className = "error";
          let friendlyError = error.message.includes("Failed to fetch") ? "Error de red. Revisa la consola (F12) para detalles de CORS." : error.message;
          if (error.message.includes("text/plain")) {
             friendlyError = "Error de API. Revisa la URL de tu Apps Script.";
          }
          statusDiv.innerHTML = `Error: ${friendlyError}`;
        } finally {
          button.disabled = false;
        }
      }
    </script>
  </body>
</html>
